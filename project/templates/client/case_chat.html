{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ case.case_title }} | Chat History</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #fff; font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .animate-fade-in-up { animation: fadeInUp 0.3s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden font-sans">
    
    <div class="flex-1 flex flex-col min-w-0">
        <header class="h-16 bg-slate-900 border-b border-slate-800 flex items-center px-6 justify-between shrink-0 z-20">
            <div class="flex items-center gap-4">
                <a href="{% if request.user == case.lawyer %}{% url 'lawyer_dashboard' %}{% else %}{% url 'user_dashboard' %}{% endif %}" 
                   class="text-slate-400 hover:text-white transition-colors">
                    <i class="fas fa-arrow-left text-lg"></i>
                </a>
                <div>
                    <h1 class="font-bold text-lg flex items-center gap-2 text-white">
                        {{ case.case_title }}
                        {% if case.status == 'Accepted' %}
                            <span class="bg-emerald-500/10 text-emerald-400 px-2 py-0.5 rounded text-[10px] uppercase font-bold border border-emerald-500/20">Active Session</span>
                        {% endif %}
                    </h1>
                    <p class="text-xs text-slate-500">
                        Chat with <span class="text-slate-300">{% if request.user == case.lawyer %}{{ case.client.first_name }}{% else %}Adv. {{ case.lawyer.first_name }}{% endif %}</span>
                    </p>
                </div>
            </div>
            
            <div class="flex gap-3">
                {% if case.fir_document %}
                    <a href="{{ case.fir_document.url }}" target="_blank" class="bg-slate-800 hover:bg-slate-700 text-white px-3 py-1.5 rounded-lg text-xs flex items-center gap-2 border border-white/5 transition-all">
                        <i class="fas fa-file-invoice text-indigo-400"></i> View FIR
                    </a>
                {% endif %}

                {% if request.user == case.lawyer and case.status == 'Accepted' %}
                    <a href="{% url 'virtual_court_view' case.id %}" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 shadow-lg shadow-purple-900/20 transition-all">
                        <i class="fas fa-gavel"></i> Virtual Court
                    </a>
                {% endif %}
            </div>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-6 bg-[#020617]">
            {% for chat in case.chat_messages.all %}
                <div class="flex flex-col w-full {% if chat.sender == request.user %}items-end{% else %}items-start{% endif %} animate-fade-in-up">
                    <div class="max-w-[85%] md:max-w-[65%]">
                        <p class="text-[9px] uppercase tracking-widest text-slate-600 mb-1 px-1 {% if chat.sender == request.user %}text-right{% endif %}">
                            {{ chat.sender.first_name }} â€¢ {{ chat.timestamp|date:"H:i" }}
                        </p>

                        <div class="p-4 rounded-2xl shadow-lg text-sm leading-relaxed 
                            {% if 'FORWARDED CASE FILE' in chat.message %}
                                bg-red-600/20 text-red-100 border border-red-500/40 rounded-tl-none
                            {% elif chat.sender == request.user %}
                                bg-indigo-600 text-white rounded-tr-none
                            {% else %}
                                bg-slate-800 text-slate-200 border border-slate-700 rounded-tl-none
                            {% endif %}">
                            
                            {% if "FORWARDED CASE FILE" in chat.message %}
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-2 text-red-400 font-black text-[10px] uppercase tracking-tighter">
                                        <i class="fas fa-exclamation-triangle"></i> Official AI Case File
                                    </div>
                                </div>
                            {% endif %}

                            {% if chat.message %}
                                <p class="whitespace-pre-wrap">{{ chat.message }}</p>
                            {% endif %}

                            {% if "FORWARDED CASE FILE" in chat.message and request.user == case.lawyer %}
                                <div class="mt-4 pt-3 border-t border-red-500/20">
                                    <form action="{% url 'load_client_case_to_court' case.id %}" method="POST">
                                        {% csrf_token %}
                                        <button type="submit" class="w-full py-2 bg-red-600 hover:bg-red-500 text-white text-[10px] font-bold rounded-lg transition-colors flex items-center justify-center gap-2 shadow-lg">
                                            <i class="fas fa-share-square"></i> FORWARD CASE TO COURT
                                        </button>
                                    </form>
                                </div>
                            {% endif %}

                            {% if chat.file %}
                                <a href="{{ chat.file.url }}" target="_blank" class="mt-3 flex items-center gap-3 bg-black/40 p-3 rounded-xl hover:bg-black/60 transition-all border border-white/10">
                                    <i class="fas fa-file-pdf {% if 'FORWARDED CASE FILE' in chat.message %}text-red-400{% else %}text-white/50{% endif %}"></i>
                                    <div class="flex-1">
                                        <p class="text-[10px] font-bold">DOCUMENT ATTACHED</p>
                                        <p class="text-[9px] opacity-60">Click to view original file</p>
                                    </div>
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="flex flex-col items-center justify-center h-full text-slate-600 italic">
                    <i class="fas fa-comments text-4xl mb-2 opacity-20"></i>
                    <p class="text-xs">No conversation started yet.</p>
                </div>
            {% endfor %}
        </div>

        <div class="p-4 bg-slate-900 border-t border-slate-800 shrink-0">
            {% if case.status == 'Accepted' %}
                <form method="POST" enctype="multipart/form-data" class="max-w-4xl mx-auto flex gap-3 items-end">
                    {% csrf_token %}
                    <label class="cursor-pointer text-slate-400 hover:text-indigo-400 p-3 bg-slate-800 rounded-full border border-slate-700">
                        <i class="fas fa-plus text-lg"></i>
                        <input type="file" name="file" class="hidden">
                    </label>
                    <div class="flex-1 bg-slate-800 rounded-2xl border border-slate-700 focus-within:border-indigo-500 transition-all">
                        <input type="text" name="message" class="w-full bg-transparent px-4 py-3 text-white placeholder-slate-600 outline-none" placeholder="Type a message..." autocomplete="off">
                    </div>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 text-white w-12 h-12 rounded-full flex items-center justify-center transition-all active:scale-90">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            {% else %}
                <div class="text-center py-2 text-slate-500 text-xs bg-slate-800/50 rounded-lg border border-slate-700 border-dashed italic">
                    <i class="fas fa-lock mr-2"></i> Case is currently pending approval.
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        chatContainer.scrollTop = chatContainer.scrollHeight;
    </script>
</body>
</html>